-- Create the database
CREATE DATABASE IF NOT EXISTS flight_booking_db;
USE flight_booking_db;

-- ========================
-- USERS TABLE
-- ========================
CREATE TABLE users (
    id              BIGINT AUTO_INCREMENT PRIMARY KEY,
    full_name       VARCHAR(100) NOT NULL,
    email           VARCHAR(100) UNIQUE NOT NULL,
    password_hash   VARCHAR(255) NOT NULL,
    phone_number    VARCHAR(20),
    role            ENUM('customer', 'admin', 'agent') DEFAULT 'customer',
    created_at      TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- ========================
-- AIRPORTS TABLE
-- ========================
CREATE TABLE airports (
    id              INT AUTO_INCREMENT PRIMARY KEY,
    code            CHAR(3) UNIQUE NOT NULL, -- e.g. LAX, JFK
    name            VARCHAR(100) NOT NULL,
    city            VARCHAR(100) NOT NULL,
    country         VARCHAR(100) NOT NULL
);

-- ========================
-- AIRLINES TABLE
-- ========================
CREATE TABLE airlines (
    id              INT AUTO_INCREMENT PRIMARY KEY,
    name            VARCHAR(100) NOT NULL,
    code            VARCHAR(10) UNIQUE NOT NULL,  -- e.g. BA, AA
    contact_email   VARCHAR(100),
    phone_number    VARCHAR(20)
);

-- ========================
-- FLIGHTS TABLE
-- ========================
CREATE TABLE flights (
    id                  BIGINT AUTO_INCREMENT PRIMARY KEY,
    airline_id          INT NOT NULL,
    flight_number       VARCHAR(20) NOT NULL,
    origin_airport_id   INT NOT NULL,
    destination_airport_id INT NOT NULL,
    departure_time      DATETIME NOT NULL,
    arrival_time        DATETIME NOT NULL,
    total_seats         INT NOT NULL,
    available_seats     INT NOT NULL,
    price               DECIMAL(10,2) NOT NULL,
    status              ENUM('scheduled', 'delayed', 'cancelled', 'completed') DEFAULT 'scheduled',
    created_at          TIMESTAMP DEFAULT CURRENT_TIMESTAMP,

    FOREIGN KEY (airline_id) REFERENCES airlines(id),
    FOREIGN KEY (origin_airport_id) REFERENCES airports(id),
    FOREIGN KEY (destination_airport_id) REFERENCES airports(id)
);

-- ========================
-- BOOKINGS TABLE
-- ========================
CREATE TABLE bookings (
    id              BIGINT AUTO_INCREMENT PRIMARY KEY,
    user_id         BIGINT NOT NULL,
    flight_id       BIGINT NOT NULL,
    booking_date    TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    seat_number     VARCHAR(10),
    status          ENUM('pending', 'confirmed', 'cancelled', 'checked_in') DEFAULT 'pending',

    FOREIGN KEY (user_id) REFERENCES users(id),
    FOREIGN KEY (flight_id) REFERENCES flights(id)
);

-- ========================
-- PAYMENTS TABLE
-- ========================
CREATE TABLE payments (
    id              BIGINT AUTO_INCREMENT PRIMARY KEY,
    booking_id      BIGINT NOT NULL,
    amount          DECIMAL(10,2) NOT NULL,
    currency        VARCHAR(10) DEFAULT 'USD',
    payment_method  ENUM('credit_card', 'debit_card', 'paypal', 'bank_transfer') NOT NULL,
    payment_status  ENUM('pending', 'completed', 'failed', 'refunded') DEFAULT 'pending',
    transaction_ref VARCHAR(100) UNIQUE,
    created_at      TIMESTAMP DEFAULT CURRENT_TIMESTAMP,

    FOREIGN KEY (booking_id) REFERENCES bookings(id)
);

-- ========================
-- TICKETS TABLE
-- ========================
CREATE TABLE tickets (
    id              BIGINT AUTO_INCREMENT PRIMARY KEY,
    booking_id      BIGINT NOT NULL,
    ticket_number   VARCHAR(50) UNIQUE NOT NULL,
    issued_date     DATETIME DEFAULT CURRENT_TIMESTAMP,
    qr_code_url     VARCHAR(255),
    checked_in      BOOLEAN DEFAULT FALSE,

    FOREIGN KEY (booking_id) REFERENCES bookings(id)
);

-- ========================
-- INDEXES & PERFORMANCE
-- ========================
CREATE INDEX idx_flight_number ON flights(flight_number);
CREATE INDEX idx_user_email ON users(email);
CREATE INDEX idx_booking_user ON bookings(user_id);
CREATE INDEX idx_payment_booking ON payments(booking_id);
